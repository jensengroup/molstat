\documentclass{article}

\input{../../../handout_preamble}


% ***************************************************
% HEADER INFORMATION

\title{Diffusion Coefficient of the Lennard-Jones Fluid}
\author{Molecular Statistics}
\date{2014}

% ***************************************************

\begin{document}


% ***************************************************
% BEGIN DOCUMENT
% ***************************************************


\maketitle

\section{Introduction}

In this project we elaborate on the Molecular Dynamics (MD) simulation we have been working on for the past weeks.
The main assignment for this project is to calculate the diffusion coefficient $D$ of the Lennard-Jones Fluid.\\

% Image
% http://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Diffusion.svg/220px-Diffusion.svg.png

% In Latin, "diffundere" means "to spread out".

\subsection{Diffusion}

Diffusion is the net movement of a substance (e.g., an atom, ion or molecule) from a region of high concentration to a region of low concentration.
This is also referred to as the movement of a substance down a concentration gradient\footnote{\href{http://en.wikipedia.org/wiki/Diffusion}{http://en.wikipedia.org/wiki/Diffusion}}.
Since we are dealing with a homogeneous liquid, the concentration gradient is zero.
What we are dealing with in this simulation is self-diffusion.\\

If we can calculate the two properties mean-square displacement (MSD)
or the velocity auto-correlation function (VACF)
we can calculate the self-diffusion coefficient $D$.
The relation between $D$ and the MSD/VACF is as follows:
\begin{eqnarray}
    D &=& \lim_{t\rightarrow \infty} \frac{\mathrm{MSD}(t)}{6t}\\
    D &=& \frac{1}{3} \int_0^\infty \mathrm{VACF}(t) \ \ dt
\end{eqnarray}

MSD is defined as:
\begin{eqnarray}
    \mathrm{MSD}(t) = \expval{|\vec{r}(t_0 + t) - \vec{r}(t_0)|^2}
    = \frac{1}{N} \sum_{i=1}^N | \vec{r}_i(t_0 + t) - \vec{r}_i(t_0)  |^2
\end{eqnarray}

where $\expval{x}$ indicates the expected (or average) value,
$N$ is the number of particles and $\vec{r}_i(t_0 + t)$ is the position vector of particle $i$ after time $t$ has passed.\\

VACF is defined as:
\begin{eqnarray}
    \mathrm{VACF}(t) = \expval{\vec{V}(t_0 + t)\cdot\vec{V}(t_0)}
    = \frac{1}{N} \sum_{i=1}^N \vec{V}_i(t_0 + t) \cdot \vec{V}_i(t_0)
\end{eqnarray}

where
$\vec{V}_i(t_0 + t)$ is the velocity vector for particle $i$ after time $t$ has passed and $N$ is the number of particles.

\newpage

\subsection{Usage of Correlation Function}

Due to large variations in your simulation, the diffusion constant will be heavily dependent on your choice of time origin $t_0$.
Because of this we will average the MSD and VACF over several choices of $t_0$.
That is redefining the MSD as
\begin{eqnarray}
    \mathrm{MSD}(t) = \frac{1}{NM} \sum_{j=1}^M \sum_{i=1}^N | \vec{r}_i(t_j + t) - \vec{r}_i(t_j)  |^2
\end{eqnarray}

and the VACF as 
\begin{eqnarray}
    \mathrm{VACF}(t) = \frac{1}{NM} \sum_{j=1}^M \sum_{i=1}^N \vec{V}_i(t_j + t) \cdot \vec{V}_i(t_j)
\end{eqnarray}

with $M$ being the number of time origins $t_0$ we average over.\\

When we run the actual simulation, we run it for at least $n$ steps before we do any sampling, since the system needs to be at equilibrium.
So all choices for the time origin $t_0$ must be after the initial burn-in to reach equilibrium.
In our case we will use each sample as a time origin.\\

You should calculate the average MSD for each choice of $t$ and store it in a list \code{msd\_list} where the index should represent how many time steps from the time origin the MSD is calculated.
For example the list element
\code{MSD\_list[5]}
contains the average MSD calculated 5 samples away from each time origin.
For this choice of $t$ you should average over all $n-5$ choices of $t_0$, with $n$ being your number of samples. 
This might be easier to understand by the below visualization:

\begin{figure}[htb!]
	\centering
	\psset{xunit=1cm,yunit=1cm}
	\begin{pspicture}(-6,-2)(6,3)
		
		%\psframe(-6,-2)(6,3)
		%\rput(0,0){O}

    % main line
    \psline[linewidth=2pt]{->}(-5,0)(5,0)
    \multido{\n=-5.0+.5}{21}
    {
      \psline(\n,-0.2)(\n,0.2)
    }

    % failed
    %\multido{\n=-5.0+1.0}{5}{\psline{*-}(\n,0.4)(\n,1.0)}
    %\multido{\n=-1.0+1.0}{5}{\psline{<-}(\n,0.4)(\n,1.0)}
    %\multido{\n=-1.0+1.0}{5}{
    %  \psline{<-}(\n,0.4)(\n,1.0+2.0)
    %}

    \psline{*->}(-5.0,0.4)(-5.0,1.0)(-3.0,1.0)(-3.0,0.4)
    \psline[border=2pt]{*->}(-4.5,0.4)(-4.5,1.2)(-2.5,1.2)(-2.5,0.4)
    \psline[border=2pt]{*->}(-4.0,0.4)(-4.0,1.4)(-2.0,1.4)(-2.0,0.4)
    \psline[border=2pt]{*->}(-3.5,0.4)(-3.5,1.6)(-1.5,1.6)(-1.5,0.4)

    \rput(0.0,1.0){
      $......$
    }

    \psbrace[rot=-90,nodesep=5pt](-1.5,1.8)(-3.5, 1.8){$t = 5$}
    \psbrace[rot=90,nodesep=8pt,nodesepA=-15pt](-5.0,-1.0)(5.0,-1.0){$t_{max}$}
		
	\end{pspicture}

  \label{fig:time_origins}
  \caption{
    Illustrating calculation of \code{MSD\_list[5]},
    by calculating the MSD between each time origin (dots) and
    5 steps ahead (arrow head).
  }

\end{figure}

%
% Figure
% MSD_list[5]
%

To help you, we have written the Python code to do this:

\begin{lstlisting}
t_max = n_samples/10
msd_list = np.zeros(t_max)
vacf_list = np.zeros(t_max)

for t in range(t_max):
    for t0 in range(n_samples - t):
        msd_list[t] += calculate_msd(R_list[t0+t], R_list[t0])
        vacf_list[t] += calculate_vacf(V_list[t0+t], V_list[t0])

    msd_list[t] /= (n_samples - t)
    vacf_list[t] /= (n_samples -t)
\end{lstlisting}

Note: Remember to have a \code{time\_list} with the same dimensions as \code{vacf\_list} and \code{msd\_list}, where the time for each sample is stored.
% time_list = np.arange(t_max) * sampling_freq * dt
{\bf Hint:} use \code{np.arange(t\_max)} and don't forget the time step $dt$.

\subsection{Calculating the Diffusion Coeffecient}

\subsubsection{Limit of MSD}

When we want to obtain the diffusion coefficient from MSD($t$) we want to find the limit of

\begin{align}
    \lim_{t\rightarrow \infty} \frac{\mathrm{MSD}(t)}{t}
\end{align}

by linear regression.
If you plot \code{msd\_list} as a function of the time $t$, the slope of that line is $6D$.
Luckily there is a Numpy/Scipy package for linear regression.
So import the module \code{scipy} and use it as follows: 

\begin{lstlisting}
slope, intercept, r_value, p_value, std_err = scipy.stats.linregress(X, Y)
\end{lstlisting}

where \code{X} and \code{Y} are two lists. The returned value \code{slope} is then the limit.

\begin{figure}[htb]
	\centering
  \subfloat[]{
    \includegraphics[width=0.5\textwidth]{msd_time.eps}
    \label{fig:msd_time}
  }
%  \qquad % Spacing
%  \qquad % Spacing
  \subfloat[]{
    \includegraphics[width=0.5\textwidth]{msd_time_correlated.eps}
    \label{fig:msd_time_correlated}
  }
  \caption{
    (a) Uncorrelated MSD vs time.
    (b) MSD after the correlation function has been done.
  }
\end{figure}

\newpage
\subsubsection{Integrating VACF}

When we want to find the diffusion coefficient from VACF we need to solve the integral

\begin{align}
    \int_0^\infty \mathrm{VACF}(t) \ \ dt
\end{align}

by numerical integration using the trapezoidal rule.
We have all the VACF in a list with index $i$ describing each time step, then the integral $I_i$ can be estimated as
\begin{align}
    I_i = \frac{1}{2}(\mathrm{VACF}_{i+1} 
    + \mathrm{VACF}_i) \cdot (t_{i+1} - t_i)
\end{align}

The total integral is then the sum of all the individual integrals $I_i$:

\begin{align}
    \int_0^\infty \mathrm{VACF} \ \ dt = \sum_i I_i = \sum_i \frac{1}{2}(\mathrm{VACF}_{i+1} 
    + \mathrm{VACF}_i) \cdot (t_{i+1} - t_i)
\end{align}

\begin{figure}[htb]
	\centering
  \subfloat[]{
    \includegraphics[width=0.5\textwidth]{vacf_time.eps}
    \label{fig:vacf_time}
  }
%  \qquad % Spacing
%  \qquad % Spacing
  \subfloat[]{
    \includegraphics[width=0.5\textwidth]{vacf_time_correlated.eps}
    \label{fig:vacf_time_correlated}
  }
  \caption{
    (a) VACF vs. time using a single time origin.
    (b) Averaged VACF vs. time.
  }
\end{figure}


\newpage
\section{Assignment}

The assignment is to create a Python simulation that calculates the diffusion coefficient from MSD and VACF.
Hereafter calculate the coefficient using different simulation variables.

\subsection{Simulation Setup}

First part is to setup the simulation to calculate $D$.
To make it easy to get started we have split the setup into small manageable steps.
An example for starting variables is

\begin{lstlisting}
n_particles = 108
temperature = 0.5
rho = 0.7
equlib_steps = 10000
n_steps = 10000
sample_freq = 24
dt = 0.001
\end{lstlisting}

\begin{enumerate}

    \item Define a sample frequency and save a list of position matrices \code{R} during the Velo-Verlet simulation after equilibrium has been reached.

    \item Create a function that calculates the MSD between two coordinate matrices \code{R}.

    \item Calculate MSD for each sampled \code{R} and plot MSD vs. simulation time.
    If you use the constants above it should look similar to figure \ref{fig:msd_time}.

    \item Implement averaging over time origins for the MSD and plot MSD vs. time.
    If you use the constants above it should look similar to figure \ref{fig:msd_time_correlated}.

    \item Use the averaged MSD list and the method for calculating the limit of MSD to calculate the diffusion coefficient.

    \item Follow the same procedure for calculating the diffusion coefficient with the VACF method.

\end{enumerate}

\textbf{Hint:} If you run your program with the settings suggested above, you will get $D \approx 0.05$.

\subsection{Simulations}

Now that you have a working base you will need to do the following six simulations and conclude on the results (with plots).

\begin{itemize}
    \item {\bf Simulation 1}\newline
    Check convergence of the diffusion coefficient with simulation step number.

    \item {\bf Simulation 2}\newline
    Check the convergence of the diffusion coefficient with system size (particle numbers).

    \item {\bf Simulation 3}\newline
    Check MSD/VACF over time for a given temperature at different densities.

    \item {\bf Simulation 4}\newline
    Check MSD/VACF over time for a given density $\rho$ at different temperatures.

    \item {\bf Simulation 5}\newline
    Calculate the diffusion coefficient for a given temperature at different densities.

    \item {\bf Simulation 6}\newline
    Calculate the diffusion coefficient for a given density $\rho$ for different temperatures.

\end{itemize}

% ***************************************************
% END DOCUMENT
% ***************************************************

\end{document}
